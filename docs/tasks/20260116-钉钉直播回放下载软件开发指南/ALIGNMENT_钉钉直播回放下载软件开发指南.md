# ALIGNMENT\_钉钉直播回放下载软件开发指南

## 项目特性规范

### 项目概述

- **项目名称**: DingTalk Downloader
- **项目版本**: 0.1.0
- **项目类型**: 技术文档编写
- **目标**: 编写一份专业、系统且全面的《钉钉直播回放下载软件开发指南》技术文档

### 技术栈

- **编程语言**: Python 3.8+
- **核心依赖**:
  - PyYAML >= 6.0
  - requests >= 2.31.0
- **外部工具**:
  - N_m3u8DL-RE（m3u8 下载工具）
  - ffmpeg（视频处理工具）
- **开发工具**:
  - pytest（测试框架）
  - black（代码格式化）
  - isort（导入排序）
  - mypy（类型检查）

### 项目结构

```
DingTalk-Download-Tool/
├── config/
│   └── settings.yaml           # 应用配置文件
├── docs/
│   ├── foundation/
│   │   ├── N_m3u8DL-RE.md      # N_m3u8DL-RE工具文档
│   │   ├── ffmpeg.md           # ffmpeg文档
│   │   └── 钉钉视频下载记录.md # 钉钉下载记录
│   └── tasks/                  # 任务文档目录
├── src/
│   └── dingtalk_downloader/    # 主源代码目录
│       ├── config/             # 配置模块
│       ├── downloader/         # 下载模块
│       └── utils/              # 工具模块
├── tests/                      # 测试目录
├── pyproject.toml              # 项目配置
└── requirements.txt            # 依赖列表
```

## 原始需求

### 需求描述

基于提供的文档进行深度研究与分析，编写一份专业、系统且全面的《钉钉直播回放下载软件开发指南》技术文档，该文档需存储于项目的 docs 目录下。本指南旨在详细阐述如何使用 Python 语言实现钉钉直播回放视频的完整下载功能，为开发人员提供清晰、可操作的技术指导。

### 核心内容要求

#### 1. 功能实现章节

- **Cookie 获取机制**: 详细说明获取和管理钉钉认证 Cookie 的方法，包括自动获取方案（基于 Selenium 或 Playwright 的自动化实现），需涵盖 Cookie 的存储格式、有效期管理及安全注意事项
- **钉钉直播回放链接解析**: 深入分析钉钉直播回放链接的结构，实现自动提取 m3u8 播放地址的解析算法，需处理不同直播类型（普通直播、课堂直播等）的链接格式差异
- **视频分片下载**: 基于 N_m3u8DL-RE 工具实现视频分片下载的完整流程，包括工具集成方法、参数配置详解和基于 Python 的调用方式，需实现避免限流的请求间隔控制、自动刷新认证信息的机制及断点续传功能
- **视频合并技术**: 详细阐述基于 ffmpeg 的视频分片合并技术方案，包括命令参数配置（码率、格式、质量参数）、合并流程控制和质量保证措施，支持常见视频格式（MP4 等）的输出
- **文件管理策略**: 制定标准化的文件命名规范（包含直播标题、日期、时长等要素）和存储路径管理方案（按日期/用户/课程分类），确保下载文件的有序组织和快速检索
- **配置管理**: 设计并实现基于 yaml 格式的配置文件管理系统，支持灵活配置应用参数（下载路径、并发数、超时设置、工具路径等），提供默认配置与自定义配置的合并机制
- **鉴权管理**: 实现认证信息的自动刷新机制，监控 Cookie 有效期，在过期前触发重新获取流程，确保下载过程不中断

#### 2. 错误处理章节

- **重试机制设计**: 实现完善的失败重试机制，包括可配置的重试次数、重试间隔和指数退避策略，区分网络错误、服务器错误和认证错误的不同重试逻辑
- **下载错误处理**: 详细说明 N_m3u8DL-RE 下载过程中各类错误（网络异常、分片丢失、权限错误、速率限制等）的捕获、识别与处理方案，提供错误恢复策略
- **合并错误处理**: 设计 ffmpeg 合并失败的异常处理与恢复机制，包括中间文件清理、错误日志记录和自动重试策略，确保视频文件的完整性和可用性
- **错误码体系**: 定义全面的异常类型与标准化错误码体系（包含模块标识、错误类型和具体错误编号），提供错误码与解决方案的映射关系，便于问题定位与排查

#### 3. 日志系统章节

- **日志分级策略**: 实现 DEBUG/INFO/WARNING/ERROR/CRITICAL 五级日志输出策略，满足开发调试、运行监控和问题排查等不同场景的日志需求
- **日志记录规范**: 制定关键操作节点（认证、链接解析、文件下载、视频合并等）的日志记录标准，包含必要上下文信息（时间戳、模块名、操作 ID 等），确保重要操作可追溯
- **日志管理方案**: 设计日志文件轮转与存储管理机制，包括日志文件大小限制、按时间轮转策略、备份数量控制和日志归档方案，确保日志系统高效稳定运行

#### 4. 测试与验证章节

- **单元测试**: 设计针对核心功能模块（Cookie 管理、链接解析、下载控制、视频合并等）的单元测试用例，使用 pytest 框架实现，代码覆盖率不低于 80%
- **集成测试**: 制定完整的集成测试流程，验证模块间交互的正确性，包括正常流程测试和边界条件测试
- **性能测试**: 定义性能测试指标（下载速度、CPU/内存占用、并发处理能力）与测试方法，确保软件在高负载下的稳定性和资源使用合理性
- **异常测试**: 设计异常场景模拟测试方案（网络中断、认证失效、文件损坏等），验证错误处理机制的有效性和系统恢复能力

#### 5. 代码规范章节

- **Python 风格规范**: 严格遵循 PEP 8 标准的 Python 代码风格规范，使用工具（如 flake8、pylint）进行代码风格检查
- **模块化设计**: 阐述模块化设计原则，按功能职责划分模块（认证模块、解析模块、下载模块等），确保代码的可维护性和可扩展性
- **命名规范**: 制定统一的函数、类、变量和常量命名规范，采用有意义的命名，提高代码可读性
- **文档要求**: 明确代码注释与文档字符串的编写要求，所有公共接口和核心算法需提供详细文档字符串，遵循 Google 风格或 NumPy 风格

### 文档格式要求

- 采用清晰的章节结构
- 包含必要的代码示例（完整可运行）
- 流程图（使用 mermaid 语法）
- 配置说明和参数解释
- 确保技术人员能够依据指南独立完成开发工作
- 所有代码示例需经过实际验证，确保可直接运行
- 文档格式需符合专业技术文档规范
- 包含目录、术语表、版本历史、参考文献等必要要素
- 提供清晰的导航和索引功能
- 使用 Markdown 格式编写，确保跨平台兼容性和易读性

## 任务边界确认

### 包含内容

1. 编写完整的《钉钉直播回放下载软件开发指南》技术文档
2. 文档包含 5 个核心章节：功能实现、错误处理、日志系统、测试与验证、代码规范
3. 提供完整的代码示例和流程图
4. 包含配置说明和参数解释
5. 确保文档符合专业技术文档规范

### 不包含内容

1. 不实现实际的下载功能代码（仅提供指南和示例）
2. 不进行实际的钉钉 API 调用测试
3. 不涉及钉钉的反爬虫技术规避
4. 不提供非法获取视频内容的方法
5. 不涉及钉钉的隐私数据窃取

## 需求理解

### 对现有项目的理解

#### 技术架构理解

1. **配置管理**: 项目使用 YAML 格式的配置文件（config/settings.yaml）进行应用参数管理
2. **模块化设计**: 源代码按功能模块划分（config、downloader、utils）
3. **外部工具集成**: 集成 N_m3u8DL-RE 和 ffmpeg 作为核心下载和处理工具
4. **Python 版本**: 支持 Python 3.8-3.12 版本

#### 钉钉视频下载机制理解

根据`钉钉视频下载记录.md`文档分析：

1. **m3u8 链接结构**:

   - 基础 URL: `https://dtliving-sz.dingtalk.com/live/{uuid}_normal.m3u8`
   - 认证参数: `auth_key={timestamp}-{signature}-0-{hash}`
   - 示例: `https://dtliving-sz.dingtalk.com/live/65ebb87c-aa44-4616-849c-1ff33e433997_normal.m3u8?auth_key=1768550700-93c71b307a7c4f918490104e7a7570e6-0-37f29e07c84de09781af9d69e2065b58`

2. **关键 Cookie 字段**:

   - `cna`: 设备标识
   - `dd_home_locale`: 语言设置
   - `account`: OAuth 认证信息
   - `deviceid`: 设备 ID
   - `pub_uid`: 公开用户 ID
   - `LV_PC_SESSION`: PC 会话 ID
   - `lv_token`: 直播令牌
   - `isg`: 安全标识

3. **m3u8 文件结构**:

   - 使用 HLS 协议（HTTP Live Streaming）
   - 包含多个 TS 分片文件
   - 每个分片约 32 秒
   - 分片 URL 包含 auth_key 认证参数
   - 支持`#EXT-X-DISCONTINUITY`标记（表示不连续的分片）

4. **请求头要求**:
   - `accept`: `*/*`
   - `accept-language`: `zh-CN,zh;q=0.9`
   - `referer`: `https://n.dingtalk.com/`
   - `user-agent`: 标准浏览器 UA
   - `range`: `bytes=0-`
   - `priority`: `i`

#### N_m3u8DL-RE 工具理解

根据`N_m3u8DL-RE.md`文档分析：

1. **核心功能**:

   - 支持 m3u8/HLS 流媒体下载
   - 支持多线程下载
   - 支持自动解密
   - 支持视频合并
   - 支持断点续传

2. **关键参数**:

   - `--save-dir`: 输出目录
   - `--save-name`: 保存文件名
   - `--save-pattern`: 文件命名模板
   - `--thread-count`: 下载线程数
   - `--download-retry-count`: 重试次数
   - `--http-request-timeout`: 请求超时
   - `--header`: 自定义请求头
   - `-M, --mux-after-done`: 合并参数
   - `--ffmpeg-binary-path`: ffmpeg 路径
   - `--live-perform-as-vod`: 直播转点播
   - `--custom-range`: 自定义下载范围

3. **合并选项**:
   - 支持多种格式：mkv, mp4
   - 支持多种合并工具：ffmpeg, mkvmerge
   - 可配置是否保留中间文件

#### FFmpeg 工具理解

根据`ffmpeg.md`文档分析：

- 当前文档为空，需要补充 ffmpeg 的详细参数说明

### 业务域理解

#### 钉钉直播回放场景

1. **普通直播回放**: 标准的 m3u8 视频流
2. **课堂直播回放**: 可能包含多个音视频流、字幕流
3. **直播类型差异**: 不同类型的直播可能有不同的链接格式和认证机制

#### 用户需求

1. **批量下载**: 支持批量下载多个直播回放
2. **断点续传**: 支持网络中断后继续下载
3. **自动合并**: 下载完成后自动合并为完整视频
4. **文件管理**: 按日期/课程/用户分类存储
5. **错误恢复**: 自动处理下载错误并重试

## 疑问澄清

### 需要确认的问题

#### 1. Cookie 获取方式

**问题**: 钉钉的 Cookie 获取方式有多种，需要确认推荐哪种方式
**选项**:

- 手动复制 Cookie（最简单，但需要用户操作）
- Selenium 自动化获取（需要浏览器驱动）
- Playwright 自动化获取（更现代，但学习曲线较陡）
- 直接从浏览器导出 Cookie 文件

**建议**: 基于现有项目配置和用户友好性，建议提供多种方式供用户选择，优先推荐手动复制方式，同时提供自动化获取方案作为可选功能。

#### 2. 钉钉直播链接类型

**问题**: 除了已知的普通直播（`_normal.m3u8`），是否还有其他类型的直播链接格式？
**需要确认**:

- 高清直播链接格式（如`_hd.m3u8`）
- 超清直播链接格式（如`_fhd.m3u8`）
- 课堂直播的特殊链接格式
- 不同直播类型的认证机制差异

**建议**: 在文档中提供通用的链接解析方法，同时说明可能存在的不同链接格式，并提供扩展接口以支持未来可能的新格式。

#### 3. ffmpeg 文档补充

**问题**: `ffmpeg.md`文档当前为空，需要补充哪些内容？
**建议**: 补充以下内容：

- ffmpeg 基本介绍和安装方法
- 常用视频格式转换命令
- 视频合并命令详解
- 质量参数配置（码率、分辨率、编码格式等）
- 常见错误处理方法

#### 4. 文档代码示例验证

**问题**: 文档中的代码示例需要实际验证吗？
**建议**: 所有代码示例都应经过实际验证，确保可以直接运行。对于需要外部依赖（如 Selenium、Playwright）的示例，应提供安装说明和依赖配置。

#### 5. 文档存储位置

**问题**: 技术文档应该存储在 docs 目录的哪个位置？
**建议**: 存储在`docs/`目录下，文件名为`钉钉直播回放下载软件开发指南.md`，与 foundation 目录同级。

#### 6. 文档版本控制

**问题**: 是否需要为文档添加版本历史和变更记录？
**建议**: 是的，按照专业技术文档规范，应包含版本历史章节，记录文档的版本号、发布日期、主要变更内容等。

#### 7. 术语表和参考文献

**问题**: 是否需要添加术语表和参考文献？
**建议**: 是的，应包含：

- 术语表：解释文档中使用的专业术语
- 参考文献：列出参考的官方文档、技术文章等

## 智能决策

### 基于现有项目内容的决策

#### 1. 配置管理方案

**决策**: 使用现有的 YAML 配置文件格式（config/settings.yaml），在文档中详细说明配置项的含义和用法。

**理由**:

- 项目已使用 YAML 格式，保持一致性
- YAML 格式易读易写，适合配置管理
- 支持注释，便于说明配置项含义

#### 2. 模块化设计

**决策**: 按功能职责划分模块，与现有项目结构保持一致。

**模块划分**:

- `config`: 配置管理模块
- `auth`: 认证模块（Cookie 管理）
- `parser`: 链接解析模块
- `downloader`: 下载模块
- `merger`: 合并模块
- `logger`: 日志模块
- `utils`: 工具模块

#### 3. 外部工具集成

**决策**: 继续使用 N_m3u8DL-RE 和 ffmpeg 作为核心工具，在文档中详细说明其使用方法。

**理由**:

- N_m3u8DL-RE 专门用于 m3u8 下载，功能强大
- ffmpeg 是业界标准的视频处理工具
- 两个工具都有完善的文档和社区支持

#### 4. 日志系统

**决策**: 使用 Python 标准库 logging 模块，实现五级日志输出。

**理由**:

- logging 是 Python 标准库，无需额外依赖
- 功能完善，支持日志轮转、格式化等
- 与现有配置文件中的 logging 配置项一致

#### 5. 错误处理

**决策**: 定义标准化的错误码体系，使用 Python 的异常机制。

**错误码格式**: `模块标识_错误类型_错误编号`

- 模块标识: AUTH, PARSE, DOWNLOAD, MERGE, CONFIG
- 错误类型: NET, AUTH, FILE, PARAM, UNKNOWN
- 错误编号: 三位数字

**示例**:

- `AUTH_NET_001`: 网络连接失败
- `DOWNLOAD_FILE_002`: 分片文件下载失败
- `MERGE_PARAM_003`: 合并参数错误

### 基于行业知识的决策

#### 1. Cookie 管理

**决策**: 提供多种 Cookie 获取方式，推荐手动复制方式作为默认方案。

**方案**:

1. **手动复制**: 用户从浏览器开发者工具复制 Cookie 字符串
2. **Selenium 自动化**: 使用 Selenium 自动化浏览器获取 Cookie
3. **Playwright 自动化**: 使用 Playwright 自动化浏览器获取 Cookie
4. **浏览器导出**: 从浏览器导出 Cookie 文件

**安全注意事项**:

- Cookie 不应提交到版本控制系统
- Cookie 应加密存储
- Cookie 应设置有效期
- Cookie 应定期刷新

#### 2. 文件命名规范

**决策**: 采用标准化的文件命名格式，包含关键信息。

**命名格式**: `{标题}_{日期}_{时长}.{扩展名}`

- 标题: 直播标题或课程名称（去除特殊字符）
- 日期: 直播日期（YYYYMMDD 格式）
- 时长: 视频时长（HHMMSS 格式）
- 扩展名: 视频格式（mp4、mkv 等）

**示例**: `Python课程_20260116_013045.mp4`

#### 3. 存储路径管理

**决策**: 按日期/用户/课程分类存储。

**路径结构**: `{下载目录}/{年份}/{月份}/{用户}/{课程}/`

- 下载目录: 可配置的根目录
- 年份: 四位年份（2026）
- 月份: 两位月份（01）
- 用户: 用户名或组织名
- 课程: 课程名或直播标题

**示例**: `./downloads/2026/01/张三/Python课程/`

#### 4. 重试机制

**决策**: 实现指数退避策略，区分不同错误类型。

**重试策略**:

- 网络错误: 重试 5 次，间隔 1s, 2s, 4s, 8s, 16s
- 服务器错误(5xx): 重试 3 次，间隔 2s, 4s, 8s
- 认证错误(401/403): 不重试，提示用户刷新 Cookie
- 其他错误: 重试 3 次，间隔 1s, 2s, 4s

#### 5. 日志管理

**决策**: 实现日志文件轮转，按时间和大小控制。

**轮转策略**:

- 按时间轮转: 每天一个日志文件
- 按大小轮转: 单个文件最大 10MB
- 备份保留: 保留最近 7 天的日志
- 日志归档: 超过 7 天的日志压缩归档

**日志文件命名**: `app_{日期}.log`

- 示例: `app_20260116.log`

#### 6. 测试策略

**决策**: 使用 pytest 框架，实现单元测试、集成测试、性能测试和异常测试。

**测试覆盖率**: 不低于 80%

**测试类型**:

1. **单元测试**: 测试各个模块的核心功能
2. **集成测试**: 测试模块间的交互
3. **性能测试**: 测试下载速度、资源占用
4. **异常测试**: 测试错误处理机制

#### 7. 代码规范

**决策**: 严格遵循 PEP 8 标准，使用工具进行代码检查。

**工具链**:

- black: 代码格式化
- isort: 导入排序
- mypy: 类型检查
- flake8: 代码风格检查
- pylint: 代码质量检查

**命名规范**:

- 函数: 小写字母+下划线（snake_case）
- 类: 大驼峰（PascalCase）
- 变量: 小写字母+下划线（snake_case）
- 常量: 大写字母+下划线（UPPER_CASE）

**文档字符串**: 使用 Google 风格

### 需要用户确认的决策点

#### 1. Cookie 获取优先级

**问题**: 是否将手动复制 Cookie 作为默认方案？
**建议**: 是的，手动复制方式最简单，适合大多数用户。自动化获取可以作为可选功能。

#### 2. 文档详细程度

**问题**: 文档的详细程度应该如何把握？
**建议**: 提供足够的细节，确保技术人员能够依据指南独立完成开发工作。同时保持文档的清晰性和可读性，避免过于冗长。

#### 3. 代码示例复杂度

**问题**: 代码示例应该多复杂？
**建议**: 代码示例应该完整可运行，同时保持简洁明了。对于复杂的功能，可以提供多个示例，从简单到复杂逐步展示。

#### 4. 文档更新策略

**问题**: 文档如何与代码同步更新？
**建议**: 在 CONSENSUS 文档中明确文档更新策略，确保代码变更时同步更新相关文档。

#### 5. 文档验证方法

**问题**: 如何验证文档中的代码示例？
**建议**: 在文档编写完成后，运行所有代码示例，确保可以直接运行。对于需要外部依赖的示例，提供完整的安装和配置说明。

## 下一步行动

1. 等待用户确认上述决策点
2. 根据用户反馈更新 ALIGNMENT 文档
3. 生成 CONSENSUS 文档
4. 设计系统架构
5. 拆分子任务
6. 执行文档编写任务
